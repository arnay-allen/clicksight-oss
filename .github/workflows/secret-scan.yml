# Prevent committing secrets to any branch.
# Only newly committed changes are scanned (commit range for Gitleaks, changed files for pre-commit).
# If Gitleaks finds leaks, the branch is deleted so the secrets are not left on the remote.
name: Secret scan

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  gitleaks:
    name: Gitleaks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # need history to compute commit range

      - name: Set commit range (only new commits)
        id: range
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE="${{ github.event.pull_request.base.sha }}"
            HEAD="${{ github.sha }}"
            RANGE="$(git merge-base "$BASE" "$HEAD")..$HEAD"
          else
            BEFORE="${{ github.event.before }}"
            if [ "$BEFORE" = "0000000000000000000000000000000000000000" ] || [ -z "$BEFORE" ]; then
              # New branch or first push: scan commits not in default branch
              git fetch origin "${{ github.event.repository.default_branch }}"
              BASE=$(git merge-base "origin/${{ github.event.repository.default_branch }}" HEAD)
              RANGE="${BASE}..HEAD"
            else
              RANGE="${BEFORE}..${{ github.sha }}"
            fi
          fi
          echo "range=${RANGE}" >> $GITHUB_OUTPUT
          echo "Scanning commit range: ${RANGE}"

      - name: Install Gitleaks
        run: |
          curl -sSfL https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz | tar xz
          sudo mv gitleaks /usr/local/bin/
          gitleaks version

      - name: Run Gitleaks (new commits only)
        run: gitleaks detect --source . --log-opts="${{ steps.range.outputs.range }}" --verbose --redact

  # Same checks as pre-commit, but only on changed files in this push/PR.
  pre-commit:
    name: Pre-commit (CI)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # need history for merge-base on PRs

      - name: Set base ref for diff
        id: base
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE=$(git merge-base "${{ github.event.pull_request.base.sha }}" "${{ github.sha }}")
          else
            BASE="${{ github.event.before }}"
            if [ "$BASE" = "0000000000000000000000000000000000000000" ] || [ -z "$BASE" ]; then
              git fetch origin "${{ github.event.repository.default_branch }}"
              BASE=$(git merge-base "origin/${{ github.event.repository.default_branch }}" HEAD)
            fi
          fi
          echo "base=${BASE}" >> $GITHUB_OUTPUT

      - name: Get changed files
        id: files
        run: |
          git diff --name-only --diff-filter=ACMR "${{ steps.base.outputs.base }}" HEAD > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt
          if [ -s changed_files.txt ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit on changed files only
        run: |
          if [ "${{ steps.files.outputs.has_changes }}" = "true" ]; then
            while IFS= read -r f; do [ -n "$f" ] && pre-commit run --files "$f"; done < changed_files.txt
          else
            echo "No changed files; skipping pre-commit."
          fi

  # Delete the branch when leaks are detected so secrets are not left on the remote.
  delete-branch-on-leak:
    name: Delete branch on leak
    runs-on: ubuntu-latest
    needs: gitleaks
    if: failure() && needs.gitleaks.result == 'failure'
    permissions:
      contents: write  # required to delete refs (branches)
    steps:
      - name: Set branch to delete
        id: branch
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "ref=refs/heads/${{ github.head_ref }}" >> $GITHUB_OUTPUT
            echo "name=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          else
            echo "ref=refs/heads/${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi
      - name: Skip default branches
        id: skip
        run: |
          case "${{ steps.branch.outputs.name }}" in
            main|master) echo "skip=true" >> $GITHUB_OUTPUT ;;
            *) echo "skip=false" >> $GITHUB_OUTPUT ;;
          esac
      - name: Delete branch
        if: steps.skip.outputs.skip != 'true'
        run: |
          curl -sSf -X DELETE \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/git/refs/heads/${{ steps.branch.outputs.name }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Log when default branch was not deleted
        if: steps.skip.outputs.skip == 'true'
        run: |
          echo "Branch ${{ steps.branch.outputs.name }} is a default branch; not deleted. Fix leaks and push a new commit."
